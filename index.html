<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krokat's Feral Sim (Turtle)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
</head>

<body>

    <div class="background-orb"></div>
    <div id="toast" class="toast">Action Successful!</div>

    <div id="progressOverlay" class="progress-overlay hidden">
        <div class="progress-box">
            <div id="progressText" class="progress-text">Loading...</div>
            <div class="progress-track">
                <div id="progressFill" class="progress-fill"></div>
            </div>
        </div>
    </div>

    <div class="app-layout">
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-btn active">1</div>
        </nav>

        <main class="main-content">
            <div class="container">
                
                <header>
                    <div class="header-title-row">
                        <div class="header-avatar" style="background-image: url('https://wow.zamimg.com/images/wow/icons/large/ability_druid_catform.jpg');"></div>
                        <div>
                            <h1>Krokat's Feral Sim</h1>
                            <div class="subtitle">Turtle WoW Patch 1.17.2 | Cat DPS</div>
                        </div>
                    </div>
                    <div class="header-controls">
                        <div class="sim-name-wrapper">
                            <input type="text" id="simName" value="Feral Sim 1" onchange="updateSimName()">
                        </div>
                        <div class="header-btn-group">
                            <button class="icon-btn" onclick="exportSettings()" title="Export Link">üîó</button>
                            <button class="icon-btn" onclick="importFromClipboard()" title="Import Link">üì•</button>
                        </div>
                    </div>
                </header>

                <div id="itemSelectorModal" class="modal-overlay hidden">
                    <div class="modal-box">
                        <div class="modal-header">
                            <span class="modal-title">Select Item</span>
                            <span class="modal-close" onclick="closeItemModal()">√ó</span>
                        </div>
                        <div class="modal-search">
                            <input type="text" id="itemSearchInput" placeholder="Search item..." onkeyup="filterItemList()">
                        </div>
                        <div class="modal-list" id="modalItemList">
                            </div>
                    </div>
                </div>

                <div id="enchantSelectorModal" class="modal-overlay hidden">
                    <div class="modal-box small-modal">
                        <div class="modal-header">
                            <span class="modal-title">Select Enchant</span>
                            <span class="modal-close" onclick="closeEnchantModal()">√ó</span>
                        </div>
                        <div class="modal-list" id="modalEnchantList">
                            </div>
                    </div>
                </div>

                <div id="wowTooltip" class="wow-tooltip"></div>

                <div id="singleSimView">
                    <div class="grid-container">

                        <div class="card full-width">
                            <div class="card-header clickable" onclick="toggleCard(this.querySelector('h2'))">
                                <h2>üõ°Ô∏è Gear & Stats</h2>
                                <span class="toggle-icon">‚ñº</span>
                            </div>
                            <div class="card-body">
                                <div class="char-sheet">
                                    <div class="char-left" id="charLeftCol"></div>
                                    <div class="char-middle">
                                        <div class="char-race-selector">
                                            <select id="char_race">
                                                <option value="Tauren">Tauren</option>
                                                <option value="NightElf">Night Elf</option>
                                            </select>
                                        </div>
                                        <div class="gp-stats-preview">
                                            <div class="stat-row"><span>Attack Power</span> <span id="gp_ap" class="val-orange">0</span></div>
                                            <div class="stat-row"><span>Crit Chance</span> <span id="gp_crit" class="val-orange">0%</span></div>
                                            <div class="stat-row"><span>Hit Chance</span> <span id="gp_hit" class="val-orange">0%</span></div>
                                        </div>
                                        <div style="text-align:center; margin-top:10px; font-size:0.7rem; color:#666;">
                                            <div id="dbStatus">DB Loading...</div>
                                        </div>
                                    </div>
                                    <div class="char-right" id="charRightCol"></div>
                                </div>
                                <div class="char-bottom" id="charBottomRow"></div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h2>‚öôÔ∏è Settings</h2>
                            </div>
                            <div class="card-body">
                                <div class="input-group">
                                    <label>Fight Duration (s)</label>
                                    <input type="number" id="maxTime" value="120">
                                </div>
                                <div class="input-group">
                                    <label>Iterations</label>
                                    <input type="number" id="simCount" value="1000">
                                </div>
                                <div class="input-group">
                                    <label>Calculation Method</label>
                                    <select id="calcMethod">
                                        <option value="S">Simulation (RNG)</option>
                                        </select>
                                </div>

                                <hr class="separator">
                                <h3>Enemy Properties</h3>
                                
                                <div class="input-group">
                                    <label>Target Level</label>
                                    <select id="enemy_level">
                                        <option value="60">60</option>
                                        <option value="61">61</option>
                                        <option value="62">62</option>
                                        <option value="63" selected>63 (Boss)</option>
                                    </select>
                                </div>

                                <div class="input-group">
                                    <label>Armor</label>
                                    <input type="number" id="enemy_armor" value="3731">
                                </div>
                                <div class="stat-row-small" id="info_dr">DR: 0%</div>

                                <div class="toggle-wrapper" style="margin-top:10px;">
                                    <label class="toggle">
                                        <input type="checkbox" id="enemy_can_bleed" checked>
                                        <span class="slider"></span>
                                        <span class="label-text">Can Bleed (Not Mech/Ele)</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h2>‚öîÔ∏è Rotation</h2>
                            </div>
                            <div class="card-body">
                                <div class="toggle-grid">
                                    <label class="toggle">
                                        <input type="checkbox" id="pos_behind" checked>
                                        <span class="slider"></span>
                                        <span class="label-text">Position: Behind (Shred)</span>
                                    </label>

                                    <label class="toggle">
                                        <input type="checkbox" id="use_rake" checked>
                                        <span class="slider"></span>
                                        <span class="label-text">Use Rake (Open Wounds)</span>
                                    </label>

                                    <label class="toggle">
                                        <input type="checkbox" id="use_bite" checked>
                                        <span class="slider"></span>
                                        <span class="label-text">Use Bite (5 CP)</span>
                                    </label>

                                    <hr class="separator" style="width:100%; margin: 10px 0;">

                                    <label class="toggle">
                                        <input type="checkbox" id="use_powershift" checked>
                                        <span class="slider"></span>
                                        <span class="label-text">Use Powershifting</span>
                                    </label>

                                    <label class="toggle">
                                        <input type="checkbox" id="aggressive_shift">
                                        <span class="slider"></span>
                                        <span class="label-text">Aggressive Shift (No Wait)</span>
                                    </label>
                                </div>

                                <div class="input-group" style="margin-top:15px;">
                                    <label>Shift Energy Return (Talent + Helm)</label>
                                    <input type="number" id="energy_refund_chance" value="60" title="Furor(40) + Wolfshead(20) = 60">
                                </div>
                            </div>
                        </div>

                        <div class="card full-width">
                            <div class="card-header clickable" onclick="toggleCard(this.querySelector('h2'))">
                                <h2>‚ú® Buffs & Consumables</h2>
                                <span class="toggle-icon">‚ñº</span>
                            </div>
                            <div class="card-body collapsed-content">
                                <div class="buff-grid">
                                    <div class="buff-col">
                                        <h3>Class Buffs</h3>
                                        <label class="custom-checkbox"><input type="checkbox" id="buff_motw" checked><span class="checkmark"></span> Mark of the Wild</label>
                                        <label class="custom-checkbox"><input type="checkbox" id="buff_bok" checked><span class="checkmark"></span> Blessing of Kings</label>
                                        <label class="custom-checkbox"><input type="checkbox" id="buff_blessing_might" checked><span class="checkmark"></span> Blessing of Might</label>
                                        <label class="custom-checkbox"><input type="checkbox" id="buff_trueshot"><span class="checkmark"></span> Trueshot Aura</label>
                                        <label class="custom-checkbox"><input type="checkbox" id="buff_leader" checked><span class="checkmark"></span> LotP (Aura)</label>
                                    </div>
                                    <div class="buff-col">
                                        <h3>Consumables</h3>
                                        <label class="custom-checkbox"><input type="checkbox" id="buff_food" checked><span class="checkmark"></span> Food (Str/Agi)</label>
                                        <label class="custom-checkbox"><input type="checkbox" id="buff_mongoose" checked><span class="checkmark"></span> Elixir of Mongoose</label>
                                        <label class="custom-checkbox"><input type="checkbox" id="buff_giants"><span class="checkmark"></span> Elixir of Giants</label>
                                        <label class="custom-checkbox"><input type="checkbox" id="buff_juju_power"><span class="checkmark"></span> Juju Power</label>
                                        <label class="custom-checkbox"><input type="checkbox" id="buff_juju_might"><span class="checkmark"></span> Juju Might</label>
                                    </div>
                                    <div class="buff-col">
                                        <h3>Scrolls / World</h3>
                                        <label class="custom-checkbox"><input type="checkbox" id="buff_str_scroll"><span class="checkmark"></span> Scroll of Strength IV</label>
                                        <label class="custom-checkbox"><input type="checkbox" id="buff_agi_scroll"><span class="checkmark"></span> Scroll of Agility IV</label>
                                        <label class="custom-checkbox"><input type="checkbox" id="buff_winterfall"><span class="checkmark"></span> Winterfall Firewater</label>
                                        <label class="custom-checkbox"><input type="checkbox" id="buff_kings"><span class="checkmark"></span> Kings (World/Item)</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card full-width">
                            <div class="card-header">
                                <div class="header-split">
                                    <h2>üìä Player Stats (Calculated)</h2>
                                    <label class="toggle">
                                        <input type="checkbox" id="manual_stats">
                                        <span class="slider"></span>
                                        <span class="label-text">Manual Override</span>
                                    </label>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="stats-input-grid">
                                    <div class="input-wrapper"><label>Strength</label><input type="number" id="stat_str"></div>
                                    <div class="input-wrapper"><label>Agility</label><input type="number" id="stat_agi"></div>
                                    <div class="input-wrapper"><label>Intellect</label><input type="number" id="stat_int"></div>
                                    
                                    <div class="input-wrapper"><label>Attack Power</label><input type="number" id="stat_ap"></div>
                                    <div class="input-wrapper"><label>Crit %</label><input type="number" id="stat_crit"></div>
                                    <div class="input-wrapper"><label>Hit %</label><input type="number" id="stat_hit"></div>
                                    
                                    <div class="input-wrapper"><label>Haste %</label><input type="number" id="stat_haste"></div>
                                    <div class="input-wrapper"><label>Weapon DPS</label><input type="number" id="stat_wps"></div>
                                    <div class="input-wrapper"><label>Mana Pool</label><input type="number" id="stat_mana"></div>
                                </div>

                                <hr class="separator">
                                <div class="collapsed-section-toggle" onclick="this.nextElementSibling.classList.toggle('hidden')">
                                    <span>Stat Weights (For Gear Score) ‚ñº</span>
                                </div>
                                <div class="hidden weights-container">
                                    <div class="input-wrapper"><label>AP Weight</label><input type="number" id="weight_ap" value="1.0"></div>
                                    <div class="input-wrapper"><label>Str Weight</label><input type="number" id="weight_str" value="2.0"></div>
                                    <div class="input-wrapper"><label>Agi Weight</label><input type="number" id="weight_agi" value="2.2"></div>
                                    <div class="input-wrapper"><label>Crit Weight</label><input type="number" id="weight_crit" value="20.0"></div>
                                    <div class="input-wrapper"><label>Hit Weight</label><input type="number" id="weight_hit" value="18.0"></div>
                                    <div class="input-wrapper"><label>Haste Weight</label><input type="number" id="weight_haste" value="10.0"></div>
                                </div>
                            </div>
                        </div>

                    </div> <div class="action-bar">
                        <button class="run-btn" onclick="runSimulation()">
                            <span class="run-icon">‚öîÔ∏è</span> RUN SIMULATION
                        </button>
                    </div>

                    <div id="resultsArea" class="hidden">
                        <div class="card full-width">
                            <div class="card-header">
                                <h2>üìà Simulation Results</h2>
                                <div class="view-controls">
                                    <button class="view-btn active" id="viewAvg" onclick="switchView('avg')">Average</button>
                                    <button class="view-btn" id="viewMin" onclick="switchView('min')">Min</button>
                                    <button class="view-btn" id="viewMax" onclick="switchView('max')">Max</button>
                                </div>
                            </div>
                            <div class="card-body">
                                
                                <div class="result-highlight-grid">
                                    <div class="res-box">
                                        <span class="res-label">DPS</span>
                                        <span class="res-val big" id="out_dps_main">0</span>
                                    </div>
                                    <div class="res-box">
                                        <span class="res-label">Total Damage</span>
                                        <span class="res-val" id="out_total_dmg">0</span>
                                    </div>
                                    <div class="res-box">
                                        <span class="res-label">Powershifts</span>
                                        <span class="res-val" id="out_shifts">0</span>
                                    </div>
                                    <div class="res-box">
                                        <span class="res-label">Wasted CP</span>
                                        <span class="res-val" id="out_cp_waste">0</span>
                                    </div>
                                </div>

                                <div class="table-container">
                                    <table class="result-table">
                                        <thead>
                                            <tr>
                                                <th class="text-left">Ability</th>
                                                <th class="text-right">Damage</th>
                                                <th class="text-right">%</th>
                                                <th class="bar-col">Share</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbl_body">
                                            </tbody>
                                    </table>
                                </div>

                                <div class="log-controls">
                                    <h3>Combat Log Sample (First Iteration/Min)</h3>
                                    <button class="small-btn" onclick="exportCSV()">Download CSV</button>
                                </div>
                                <div class="log-container">
                                    <table class="log-table">
                                        <thead>
                                            <tr>
                                                <th>Time</th>
                                                <th>Source</th>
                                                <th>Event</th>
                                                <th>Result</th>
                                                <th>Amount</th>
                                                <th>Energy</th>
                                                <th>CP</th>
                                                <th>Mana</th>
                                            </tr>
                                        </thead>
                                        <tbody id="logBody">
                                            </tbody>
                                    </table>
                                </div>
                                
                                <div style="text-align:right; margin-top:10px;">
                                    <button class="small-btn" onclick="generateSummaryImage()">üì∏ Create Summary Image</button>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                <div id="comparisonView" class="hidden">
                    <div class="card full-width">
                        <div class="card-header">
                            <h2>üìä Simulation Comparison</h2>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="comp-table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Time</th>
                                            <th>AP</th>
                                            <th>Crit</th>
                                            <th>Hit</th>
                                            <th>Rotation</th>
                                            <th style="text-align:right">Min DPS</th>
                                            <th style="text-align:right">Avg DPS</th>
                                            <th style="text-align:right">Max DPS</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="comparisonBody">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div id="summaryCardWrapper" style="position:absolute; left:-9999px; top:0;">
        <div id="summaryCard" class="summary-card">
            <div class="sum-header">
                <div class="sum-title">Feral Druid Simulation</div>
                <div class="sum-subtitle" id="sumSimName">Sim Name</div>
                <div class="sum-date" id="sumDate">Date</div>
            </div>
            <div class="sum-body">
                <div class="sum-col">
                    <div class="sum-big-stat">
                        <span class="sum-dps-label">Average DPS</span>
                        <span class="sum-dps-val" id="sumAvg">0</span>
                    </div>
                    <div class="sum-small-stats">
                        <div>Min: <span id="sumMin">0</span></div>
                        <div>Max: <span id="sumMax">0</span></div>
                        <div>Duration: <span id="sumTime">0s</span></div>
                    </div>
                    
                    <div class="sum-sec-title">Stats</div>
                    <div class="sum-row"><span>AP</span> <span id="sumAP">0</span></div>
                    <div class="sum-row"><span>Crit</span> <span id="sumCrit">0%</span></div>
                    <div class="sum-row"><span>Hit</span> <span id="sumHit">0%</span></div>
                    <div class="sum-row"><span>Haste</span> <span id="sumHaste">0%</span></div>
                    
                    <div class="sum-sec-title" style="margin-top:15px;">Enemy</div>
                    <div class="sum-row"><span>Level</span> <span id="sumLvl">63</span></div>
                    <div class="sum-row"><span>Armor</span> <span id="sumArmor">0</span></div>
                </div>
                <div class="sum-col">
                    <div class="sum-sec-title">Rotation & Tactics</div>
                    <ul class="sum-list" id="sumRotaList"></ul>
                </div>
                <div class="sum-col">
                    <div class="sum-sec-title">Gear Summary</div>
                    <ul class="sum-list" id="sumGearList"></ul>
                </div>
            </div>
            <div class="summary-footer">Krokat's Feral Sim (Turtle WoW)</div>
        </div>
    </div>

    <script src="js/01_globals.js"></script>
    <script src="js/02_utils.js"></script>
    <script src="js/03_gear.js"></script>
    <script src="js/04_ui.js"></script>
    <script src="js/05_engine.js"></script>
    <script src="js/06_main.js"></script>
</body>
</html>